# APPROOV INTEGRATION EXAMPLE

To see how a server runs with an Approov integration please follow the
[Approov Shapes Demo Server](./docs/approov-shapes-demo-server.md) walk-through.

The concrete implementation of the Approov Shapes Demo Server is in the
[approov-protected-server.js](./server/approov-protected-server.js) file, that
is a simple NodeJS Express server with some endpoints protected by Approov and
other endpoints without any Approov protection.

Now let's continue reading this README for a **quick start** introduction in how
to integrate Approov on a current project by using as an example the code for
the Approov Shapes Demo Server.


## APPROOV VALIDATION PROCESS

Before we dive into the code we need to understand the Approov validation
process on the back-end side.

### The Approov Token

API calls protected by Approov will typically include a header holding an Approov
JWT token. This token must be checked to ensure it has not expired and that it is
properly signed with the secret shared between the back-end and the Approov cloud
service.

We will use a NodeJS package to help us in the validation of the Approov JWT
token.

> **NOTE**
>
> Just to be sure that we are on the same page, a JWT token have 3 parts, that
> are separated by dots and represented as a string in the format of
> `header.payload.signature`. Read more about JWT tokens [here](https://jwt.io/introduction/).

### The Custom Payload Claim

A custom payload claim in an Approov token is a base64 encoded sha256 hash of
some unique identifier we may want to tie with the Approov token to enhance
the security on that request, like an OAUTH2 token, but you are free to use what
so ever you may want.

Dummy example for the JWT token middle part, the payload:

```
{
    "exp": 123456789, # required - the timestamp for when the token expires.
    "pay":"f3U2fniBJVE04Tdecj0d6orV9qT9t52TjfHxdUqDBgY=" # optional - a sha256 hash of the claim, encoded with base64.
}
```

The custom payload claim in an Approov token is the one in the `pay` key:

```
"pay":"f3U2fniBJVE04Tdecj0d6orV9qT9t52TjfHxdUqDBgY="
```

**ALERT**:

Please bear in mind that the custom payload claim is not meant to pass
application data to the API server, but you can pass a base64 encoded sha256 hash
of the data you want to send from the mobile app into the API server and have it
hashing the data that was sent as usual on the request and compare it with the
custom payload claim base64 sha256 hash to confirm that the integrity of the
data was not compromised.


## SYSTEM CLOCK

In order to correctly check for the expiration times of the Approov tokens is
very important that the Python Flask server is synchronizing automatically the
system clock over the network with an authoritative time source. In Linux this
is usual done with a NTP server.


## REQUIREMENTS

We will use NodeJS 10 with an Express API server to run our code.

Docker is required for the ones wanting to use the docker environment provided
by the [stack](./stack) bash script, that is a wrapper around docker commands.

Postman is the tool we recommend to be used when simulating the queries against
the API, but feel free to use any other tool of your preference.


## THE DOCKER STACK

We recommend the use of the included Docker stack to play with this Approov
integration.

For details in how to use it you need to follow the setup instructions in the
[Approov Shapes Demo Server](./docs/approov-shapes-demo-server.md#development-environment)
walk-through, but feel free to use your local environment to play with this
Approov integration.


## HOW TO USE THE POSTMAN COLLECTION

This [Postman collection](./postman/shapes-demo-server.postman_collection.json)
contains all the API endpoints and is useful to help us playing with the API and
have a better understanding how the Approov integration works.

The Approov tokens used in the headers where generated with
[this helper script](./server/test/helpers/generate-token.py) and they cover all
necessary scenarios, but feel free to use the script to generate valid and
invalid tokens with different expire times and custom payload claims.

We recommend you to go over the
[Approov Shapes Demo Server](./docs/approov-shapes-demo-server.md) walk-through
to have a better understanding how the Postman collection is used.


## THE POSTMAN COLLECTION

Import this [Postman collection](https://gitlab.com/snippets/1799104/raw) that
contains all the API endpoints for the Approov Shapes Demo Server and we
strongly recommend you to follow
[this demo walk-through](./docs/approov-shapes-demo-server.md) after finishing
the Approov integration that we are about to start.

The Approov tokens used in the headers of this Postman collection where
generated by [this helper script](./bin/generate-token.js) and
they cover all necessary scenarios, but feel free to use the script to generate
some more valid and invalid tokens, with different expire times and custom
payload claims. Some examples of using it can be found [here](./docs/approov-shapes-demo-server.md#approov-tokens-generation).


## INSTALL DEPENDENCIES

If not already using the NPM packages `express-jwt` and `dotenv` in your
project, please add them:

```bash
npm install --save express-jwt dotenv debug
```

## ORIGINAL SERVER

Let's use the [original-server.js](./server/original-server.js) as an example
for a current server where we want to add Approov to protect some or all the
endpoints.

After we add only the necessary code to integrate Approov, the end result
will look like we have now in the [approov-protected-server.js](./server/approov-protected-server.js).


## HOW TO INTEGRATE

We will learn how to go from the [original-server.js](./server/original-server.js) to the
[approov-protected-server.js](./server/approov-protected-server.js) and how to configure the server.

In order to be able to check the Approov token the `express-jwt` library needs
to know the secret used by the Approov cloud service to sign it. A secure way to
do this is by passing it as an environment variable, as you can see we have done
[here](./server/configuration.js#L28).

Next we need to define two callbacks to be used during the Approov token check
process. One callback is to perform the check itself with the library
`express-jwt` and the other is to handle any errors occurred during that check.

Let's breakdown the example implementation to make it easier to adapt to your
current project.


### Require Dependencies

We need to require the dependencies we installed before.

[Configuration file](./server/configuration.js#L1):

```js
// file: configuration.js

// if not already in use add:
require('dotenv').config()
```

[Approov Protected Server file](./server/configuration.js#L1):

```js
// file: approov-protected-server.js

const jwt = require('express-jwt')
const crypto = require('crypto')
```

### Setup Environment

If you don't have already an `.env` file, then you need to create one in the
root of your project by using this [.env.example](./.env.example) as your
starting point.

The `.env` file must contain this two variables:

```env
# the base64 encode is for value: approov-base64-encoded-secret
APPROOV_BASE64_SECRET=YXBwcm9vdi1iYXNlNjQtZW5jb2RlZC1zZWNyZXQ=
APPROOV_ABORT_REQUEST_ON_INVALID_TOKEN=true
APPROOV_ABORT_REQUEST_ON_INVALID_CUSTOM_PAYLOAD_CLAIM=true
APPROOV_LOGGING_ENABLED=true
```


Now we can read them from our code, like is done in the [configuration file](./server/configuration.js#L31-L61):

```js
// file: configuration.js

///////////////////////////
/// APPROOV ENVIRONMENT
//////////////////////////

let isToAbortRequestOnInvalidToken = true
let isToAbortOnInvalidClaim = true
let isApproovLoggingEnabled = true
const abortRequestOnInvalidToken = dotenv.parsed.APPROOV_ABORT_REQUEST_ON_INVALID_TOKEN || 'true'
const abortOnInvalidClaim = dotenv.parsed.APPROOV_ABORT_REQUEST_ON_INVALID_CUSTOM_PAYLOAD_CLAIM || 'true'
const approovLoggingEnabled = dotenv.parsed.APPROOV_LOGGING_ENABLED || 'true'

if (abortRequestOnInvalidToken.toLowerCase() === 'false') {
  isToAbortRequestOnInvalidToken = false
}

if (abortOnInvalidClaim.toLowerCase() === 'false') {
  isToAbortOnInvalidClaim = false
}

if (approovLoggingEnabled.toLowerCase() === 'false') {
  isApproovLoggingEnabled = false
}

const approov = {
  abortRequestOnInvalidToken: isToAbortRequestOnInvalidToken,
  abortRequestOnInvalidCustomPayloadClaim: isToAbortOnInvalidClaim,
  approovLoggingEnabled: isApproovLoggingEnabled,

  // The Approov base64 secret must be retrieved from the Approov admin portal
  base64Secret: dotenv.parsed.APPROOV_BASE64_SECRET,
}


////////////////////////////
/// EXPORT CONFIGURATION
///////////////////////////

module.exports = {
  server,
  approov,
}
```

### Customizable Approov Callbacks

This are callbacks used in the Approov Integration that you may want to
customize to the needs of your application.

Lets's start with the logging callback that we can see in [approov-protected-server.js](./server/approov-protected-server.js#L53-L56):

```js
// file: approov-protected-server.js

// Callback to be customized with your preferred way of logging.
const logApproov = function(req, res, message) {
    debug(buildLogMessagePrefix(req, res) + ' ' + message)
}
```

Next we have the callback to get the claim value that we want to compare against
the custom payload claim in the Approov token, as see in [approov-protected-server.js](./server/approov-protected-server.js#L58-L64):

```js
// file: approov-protected-server.js

// Callback to be personalized in order to get the claim value being used by
// your application.
// In the current scenario we use an Oauth2 token, but feel free to use what
// suits best your needs.
const getClaimValueFromRequest = function(req) {
  return req.get('oauth2-token')
}
```

Each time an Approov token doesn't validate for any reason the Approov
integration will pass the control to the application logic by invoking a callback as the one defined in [approov-protected-server.js](./server/approov-protected-server.js#L66-L88):

```js
// file: approov-protected-server.js

// Callback to be customized with how you want to handle a request with an
// invalid Approov token.
// The code included in this callback is provided as an example, that you can
// keep or totally change it in a way that best suits your needs.
const handlesRequestWithInvalidApproovToken = function(err, req, res, next) {

  // Logging a message to make clear in the logs what was the action we took.
  // Feel free to skip it if you think is not necessary to your use case.
  let message = 'REQUEST WITH INVALID APPROOV TOKEN'

  if (config.approov.abortRequestOnInvalidToken === true) {
    message = 'REJECTED ' + message
    res.status(400)
    logApproov(req, res, message)
    res.json({})
    return
  }

  message = 'ACCEPTED ' + message
  logApproov(req, res, message)
  next()
  return
}
```

The last customizable callback will be invoked by the Approov integration to
allow the application to decide what action to take when the request claim value
doesn't match the custom payload claim value in the Approov token, as defined in
[approov-protected-server.js](./server/approov-protected-server.js#L90-L113):

```js
// file: approov-protected-server.js

// Callback to be customized with how you want to handle a request where the
// claim in the request doesn't match the custom payload claim in the Approov
// token.
// The code included in this callback is provided as an example, that you can
// keep or totally change it in a way that best suits your needs.
const handlesRequestWithInvalidClaimValue = function(req, res, next) {

  // Logging here to make clear in the logs what was the action we took.
  // Fseel free to skip it if you think is not necessary to your use case.
  let message = 'REQUEST WITH INVALID CLAIM VALUE'

  if (config.approov.abortRequestOnInvalidCustomPayloadClaim === true) {
    message = 'REJECTED ' + message
    res.status(400)
    logApproov(req, res, message)
    res.json({})
    return
  }

  message = 'ACCEPTED ' + message
  logApproov(req, res, message)
  next()
  return
}
```

### Approov Integration Core Callbacks

This core callbacks are specific to the Approov integration and once they don't
interfere with the flow or behavior of your application we think they are not in
need of being customized.

#### Helper Functions

The core callbacks will need some very basic helper functions, like the ones
defined in the [approov-protected-server](./server/approov-protected-server.js#L125-L137):

```js
// file: approov-protected-server.js

const isEmpty = function(value) {
  return  (value === undefined) || (value === null) || (value === '')
}

const isString = function(value) {
  return (typeof(value) === 'string')
}

const isEmptyString = function(value) {
  return (isEmpty(value) === true) || (isString(value) === false) ||  (value.trim() === '')
}
```

#### Approov Token

[This callback](./server/approov-protected-server.js#L143-L152) will be used in the
middleware to check the Approov token:

```js
// file: approov-protected-server.js

// Callback that performs the Approov token check using the express-jwt library
const checkApproovToken = jwt({
  secret: Buffer.from(config.approov.base64Secret, 'base64'), // decodes the Approov secret
  requestProperty: 'approovTokenDecoded',
  getToken: function fromApproovTokenHeader(req) {
    req.approovTokenError = false
    return req.get('approov-token')
  },
  algorithms: ['HS256']
})
```

Then we need [this callback](./server/approov-protected-server.js#L154-L168) to
handle any error that may occur during the Approov token check:

```js
// file: approov-protected-server.js

// Callback to handle the errors occurred while checking the Approov token.
const handlesApproovTokenError = function(err, req, res, next) {

  if (err.name === 'UnauthorizedError') {
    message = 'APPROOV TOKEN ERROR: ' + err
    logApproov(req, res, message)

    req.approovTokenError = true
    handlesRequestWithInvalidApproovToken(err, req, res, next)
    return
  }

  next()
  return
}
```

Finally we want to handle when the Approov token succeeds the validation process,
as we have done [approov-protected-server.js](./server/approov-protected-server.js#L170-L178)

```js
// file: approov-protected-server.js

// Callback to handles when an Approov token is successfully validated.
const handlesApproovTokenSuccess = function(req, res, next) {
    if (req.approovTokenError === false) {
      logApproov(req, res, 'ACCEPTED REQUEST WITH VALID APPROOV TOKEN')
    }

    next()
    return
}
```

#### Custom Payload Claim

We will use this two functions to validate if the claim value in the request
matches the custom payload claim in the Approov token, as we can see in the
[approov-protected-server.js](./server/approov-protected-server.js#L182-L241):

```js
// file: approov-protected-server.js

// Validates if the Approov contains the same claim has in the request
const isClaimValueInRequestValid = function(requestClaimValue, approovTokenDecoded) {

  if (isEmptyString(requestClaimValue)) {
    return false
  }

  if (isEmpty(approovTokenDecoded)) {
    return false
  }

  // checking if the approov token contains a custom payload claim and verify it.
  if (! isEmptyString(approovTokenDecoded.pay)) {

    const requestBase64ClaimValueHash = crypto.createHash('sha256').update(requestClaimValue, 'utf-8').digest('base64')

    return approovTokenDecoded.pay === requestBase64ClaimValueHash
  }

  // The Approov failover running in the Google cloud doesn't return the custom
  // payload claim, thus we always need to have a pass when is not present.
  return true
}


// Callback to check if the custom payload claim in an Approov token matches the
// claim in the request
const checkApproovTokenCustomPayloadClaim = function(req, res, next){

  if (req.approovTokenError === true) {
    next()
    return
  }

  let message = 'REQUEST WITH VALID CLAIM VALUE'

  const requestClaimValue = getClaimValueFromRequest(req)

  if (isEmptyString(requestClaimValue)) {
    message = 'REQUEST WITHOUT A CLAIM VALUE'
    handlesRequestWithInvalidClaimValue(req, res, next)
    return
  }

  // checks if the claim from the request matches the custom payload claim in
  // the Approov token.
  const isValidClaim = isClaimValueInRequestValid(requestClaimValue, req.approovTokenDecoded)

  if (isValidClaim === false) {
    message = 'REQUEST WITH CLAIM VALUE NOT MATCHING THE CUSTOM PAYLOAD CLAIM IN THE APPROOV TOKEN'
    logApproov(req, res, message)
    handlesRequestWithInvalidClaimValue(req, res, next)
    return
  }


  message = 'ACCEPTED ' + message
  logApproov(req, res, message)
  next()
  return
}
```


### Middleware

We will use the middleware approach to intercept all endpoints we want to protect
with an Approov Token. So any interceptor must be placed before we declare the
endpoints  we want to protect, like is done in the
[approov-protected-server.js](./server/approov-protected-server.js#L165-L186).

The following examples will use the callbacks we already have defined
[here](#approov-integration-core-callbacks) to pass as the second parameter to
the middleware interceptors.

#### For specific endpoints

To protect specific endpoints in a current server we only need to add the Approov
interceptors for each endpoint we want to protect, as we have done [here](./server/approov-protected-server.js#L245-L266):

```js
// file: approov-protected-server.js

// Intercepts all calls to the shapes endpoint to validate the Approov token.
app.use('/shapes', checkApproovToken)

// Handles failure in validating the Approov token
app.use('/shapes', handlesApproovTokenError)

// Handles requests where the Approov token is a valid one.
app.use('/shapes', handlesApproovTokenSuccess)

// Intercepts all calls to the forms endpoint to validate the Approov token.
app.use('/forms', checkApproovToken)

// Handles failure in validating the Approov token
app.use('/forms', handlesApproovTokenError)

// Handles requests where the Approov token is a valid one.
app.use('/forms', handlesApproovTokenSuccess)

// checks if the custom payload claim is present in the Approov token and
// matches the claim used by the mobile app, that in this case we decided to be
// the ouath2 token, but you may want to use another type of claim.
app.use('/forms', checkApproovTokenCustomPayloadClaim)
```

#### For all endpoints

To protect all endpoints we only need to declare the Approov interceptor for the
API root endpoint `/`, thus we need to modify the above code to look like this:

```js
// file: approov-protected-server.js

// Intercepts all calls to the shapes endpoint to validate the Approov token.
app.use('/', checkApproovToken)

// Handles failure in validating the Approov token
app.use('/', handlesApproovTokenError)

// Handles requests where the Approov token is a valid one.
app.use('/', handlesApproovTokenSuccess)

// only use in the root endpoint `/` if you want to validate the custom payload
// claim in all endpoints, otherwise declare it per endpoint you want to protect.
app.use('/', checkApproovTokenCustomPayloadClaim)
```

### The Code Difference

If we compare the [original-server.js](./server/original-server.js) with the
[approov-protected-server.js](./server/approov-protected-server.js) we will see
this file difference:

```js
--- /home/sublime/workspace/node/express/server/original-server.js
+++ /home/sublime/workspace/node/express/server/approov-protected-server.js
@@ -1,4 +1,6 @@
-const debug = require('debug')('original-server')
+const debug = require('debug')('approov-protected-server')
+const jwt = require('express-jwt')
+const crypto = require('crypto')
 const config = require('./configuration')
 const https = require('https')
 const fs = require('fs')
@@ -41,6 +43,239 @@
 }


+////////////////////////////////////////////////////////////////////////////////
+/// YOUR APPLICATION CUSTOMIZABLE CALLBACKS FOR THE APPROOV INTEGRATION
+////////////////////////////////////////////////////////////////////////////////
+///
+/// Feel free to customize this callbacks to best suite the needs your needs.
+///
+
+// Callback to be customized with your preferred way of logging.
+const logApproov = function(req, res, message) {
+    debug(buildLogMessagePrefix(req, res) + ' ' + message)
+}
+
+// Callback to be personalized in order to get the claim value being used by
+// your application.
+// In the current scenario we use an Oauth2 token, but feel free to use what
+// suits best your needs.
+const getClaimValueFromRequest = function(req) {
+  return req.get('oauth2-token')
+}
+
+// Callback to be customized with how you want to handle a request with an
+// invalid Approov token.
+// The code included in this callback is provided as an example, that you can
+// keep or totally change it in a way that best suits your needs.
+const handlesRequestWithInvalidApproovToken = function(err, req, res, next) {
+
+  // Logging a message to make clear in the logs what was the action we took.
+  // Feel free to skip it if you think is not necessary to your use case.
+  let message = 'REQUEST WITH INVALID APPROOV TOKEN'
+
+  if (config.approov.abortRequestOnInvalidToken === true) {
+    message = 'REJECTED ' + message
+    res.status(400)
+    logApproov(req, res, message)
+    res.json({})
+    return
+  }
+
+  message = 'ACCEPTED ' + message
+  logApproov(req, res, message)
+  next()
+  return
+}
+
+// Callback to be customized with how you want to handle a request where the
+// claim in the request doesn't match the custom payload claim in the Approov
+// token.
+// The code included in this callback is provided as an example, that you can
+// keep or totally change it in a way that best suits your needs.
+const handlesRequestWithInvalidClaimValue = function(req, res, next) {
+
+  // Logging here to make clear in the logs what was the action we took.
+  // Fseel free to skip it if you think is not necessary to your use case.
+  let message = 'REQUEST WITH INVALID CLAIM VALUE'
+
+  if (config.approov.abortRequestOnInvalidCustomPayloadClaim === true) {
+    message = 'REJECTED ' + message
+    res.status(400)
+    logApproov(req, res, message)
+    res.json({})
+    return
+  }
+
+  message = 'ACCEPTED ' + message
+  logApproov(req, res, message)
+  next()
+  return
+}
+
+
+////////////////////////////////////////////////////////////////////////////////
+/// STARTS NON CUSTOMIZABLE LOGIC FOR THE APPROOV INTEGRATION
+////////////////////////////////////////////////////////////////////////////////
+///
+/// This section contains code that is specific to the Approov integration,
+/// thus we think that is not necessary to customize it, once is not
+/// interfering with your application logic or behavior.
+///
+
+////// APPROOV HELPER FUNCTIONS //////
+
+const isEmpty = function(value) {
+  return  (value === undefined) || (value === null) || (value === '')
+}
+
+const isString = function(value) {
+  return (typeof(value) === 'string')
+}
+
+const isEmptyString = function(value) {
+  return (isEmpty(value) === true) || (isString(value) === false) ||  (value.trim() === '')
+}
+
+
+////// APPROOV TOKEN //////
+
+
+// Callback that performs the Approov token check using the express-jwt library
+const checkApproovToken = jwt({
+  secret: Buffer.from(config.approov.base64Secret, 'base64'), // decodes the Approov secret
+  requestProperty: 'approovTokenDecoded',
+  getToken: function fromApproovTokenHeader(req) {
+    req.approovTokenError = false
+    return req.get('approov-token')
+  },
+  algorithms: ['HS256']
+})
+
+// Callback to handle the errors occurred while checking the Approov token.
+const handlesApproovTokenError = function(err, req, res, next) {
+
+  if (err.name === 'UnauthorizedError') {
+    message = 'APPROOV TOKEN ERROR: ' + err
+    logApproov(req, res, message)
+
+    req.approovTokenError = true
+    handlesRequestWithInvalidApproovToken(err, req, res, next)
+    return
+  }
+
+  next()
+  return
+}
+
+// Callback to handles when an Approov token is successfully validated.
+const handlesApproovTokenSuccess = function(req, res, next) {
+    if (req.approovTokenError === false) {
+      logApproov(req, res, 'ACCEPTED REQUEST WITH VALID APPROOV TOKEN')
+    }
+
+    next()
+    return
+}
+
+
+////// CUSTOM PAYLOAD CLAIN IN THE APPROOV TOKEN //////
+
+
+// Validates if the Approov contains the same claim has in the request
+const isClaimValueInRequestValid = function(requestClaimValue, approovTokenDecoded) {
+
+  if (isEmptyString(requestClaimValue)) {
+    return false
+  }
+
+  if (isEmpty(approovTokenDecoded)) {
+    return false
+  }
+
+  // checking if the approov token contains a custom payload claim and verify it.
+  if (! isEmptyString(approovTokenDecoded.pay)) {
+
+    const requestBase64ClaimValueHash = crypto.createHash('sha256').update(requestClaimValue, 'utf-8').digest('base64')
+
+    return approovTokenDecoded.pay === requestBase64ClaimValueHash
+  }
+
+  // The Approov failover running in the Google cloud doesn't return the custom
+  // payload claim, thus we always need to have a pass when is not present.
+  return true
+}
+
+// Callback to check if the custom payload claim in an Approov token matches the
+// claim in the request
+const checkApproovTokenCustomPayloadClaim = function(req, res, next){
+
+  if (req.approovTokenError === true) {
+    next()
+    return
+  }
+
+  let message = 'REQUEST WITH VALID CLAIM VALUE'
+
+  const requestClaimValue = getClaimValueFromRequest(req)
+
+  if (isEmptyString(requestClaimValue)) {
+    message = 'REQUEST WITHOUT A CLAIM VALUE'
+    handlesRequestWithInvalidClaimValue(req, res, next)
+    return
+  }
+
+  // checks if the claim from the request matches the custom payload claim in
+  // the Approov token.
+  const isValidClaim = isClaimValueInRequestValid(requestClaimValue, req.approovTokenDecoded)
+
+  if (isValidClaim === false) {
+    message = 'REQUEST WITH CLAIM VALUE NOT MATCHING THE CUSTOM PAYLOAD CLAIM IN THE APPROOV TOKEN'
+    logApproov(req, res, message)
+    handlesRequestWithInvalidClaimValue(req, res, next)
+    return
+  }
+
+
+  message = 'ACCEPTED ' + message
+  logApproov(req, res, message)
+  next()
+  return
+}
+
+/////// THE APPROOV INTERCEPTORS ///////
+
+// Intercepts all calls to the shapes endpoint to validate the Approov token.
+app.use('/shapes', checkApproovToken)
+
+// Handles failure in validating the Approov token
+app.use('/shapes', handlesApproovTokenError)
+
+// Handles requests where the Approov token is a valid one.
+app.use('/shapes', handlesApproovTokenSuccess)
+
+// Intercepts all calls to the forms endpoint to validate the Approov token.
+app.use('/forms', checkApproovToken)
+
+// Handles failure in validating the Approov token
+app.use('/forms', handlesApproovTokenError)
+
+// Handles requests where the Approov token is a valid one.
+app.use('/forms', handlesApproovTokenSuccess)
+
+// checks if the custom payload claim is present in the Approov token and
+// matches the claim used by the mobile app, that in this case we decided to be
+// the ouath2 token, but you may want to use another type of claim.
+app.use('/forms', checkApproovTokenCustomPayloadClaim)
+
+/// NOTE:
+///   Is important to place all the Approov interceptors before we declare the
+///   endpoints of the API, otherwise they will not be able to intercept any
+///   request.
+
+////////////////////////////////////////////////////////////////////////////////
+/// ENDS APPOOV INTEGRATION
+////////////////////////////////////////////////////////////////////////////////
+
 ////////////////
 // ENDPOINTS
 ////////////////
@@ -64,13 +299,11 @@

 // shapes endpoint returns a random shape.
 app.get('/shapes', function(req, res, next) {
-  logResponseToRequest(req, res)
   res.json(getRandomShapeResponse())
 })

 // shapes endpoint returns a random form.
 app.get('/forms', function(req, res, next) {
-  logResponseToRequest(req, res)
   res.json(getRandomFormResponse())
 })
```

As we can see the Approov integration in a current server is simple, easy and is
done with just a few lines of code.

If you have not done it already, now is time to follow the
[Approov Shapes Demo Server](./docs/approov-shapes-demo-server.md) walk-through
to see and have a feel for how all this works.


## PRODUCTION

In order to protect the communication between your mobile app and the API server
is important to only communicate hover a secure communication channel, aka https.

Please bear in mind that https on its own is not enough, certificate pinning
must be also used to pin the connection between the mobile app and the API
server in order to prevent [Man in the Middle Attacks](https://approov.io/docs/mitm-detection.html).

We do not use https and certificate pinning in this Approov integration example
because we want to be able to run the
[Approov Shapes Demo Server](./docs/approov-shapes-demo-server.md) in localhost.

However in production it will be mandatory to implement at least
[static pinning](https://approov.io/docs/mitm-detection.html#id1)
or [dynamic pinning](https://approov.io/docs/mitm-detection.html#dynamic-pinning).
